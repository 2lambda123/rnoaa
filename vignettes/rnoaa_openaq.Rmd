---

title: "Complementing air quality data with weather data using rnoaa"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction: getting air quality data

This vignette aims at explaining how you can complement a data.frame with weather data using rnoaa. In this vignette we shall use air quality data from the OpenAQ platform queried with the Ropenaq package, for India. Using [Ropenaq](https://github.com/masalmon/Ropenaq) one can get e.g. PM2.5 values over time in Delhi. For getting all data for march we'll loop over several pages.

```{r, message = FALSE, warning = FALSE, cache = TRUE}
library("Ropenaq")
library("dplyr")
measurementsDelhi <- NULL
for (page in 1:6){
  measurementsDelhi <- rbind(measurementsDelhi,
                             aq_measurements(city = "Delhi",
                                     parameter = "pm25",
                                     date_from = "2016-03-01",
                                     limit = 1000, 
                                     page = page))
}

measurementsDelhi %>% head() %>% knitr::kable()
```

We now transform these data into daily data.

```{r, message = FALSE, warning = FALSE, cache = TRUE}
measurementsDelhi <- measurementsDelhi %>% 
  mutate(day = as.Date(dateLocal)) %>%
  group_by(location, day) %>%
  summarize(value = mean(value),
            longitude = longitude[1],
            latitude = latitude[1])
measurementsDelhi %>% head() %>% knitr::kable()

```

Air quality and weather are correlated, so one could be interested in getting a time series of say temperature for the same location. The OpenAQ platform itself does not provide weather data but nearly all stations have geographical coordinates. Our goal here will be to use rnoaa to complement this table with precipitation and temperature.

# Find stations with the right time, space and parameter coverage

There are many weather stations in India for which we can query data using rnoaa. Let's do a map of all of them using leaflet.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
load("data/stationsIndia.RData")
```

We could start by finding all stations for India.

```{r, message = FALSE, warning = FALSE, echo = TRUE, eval = FALSE}
library("rnoa")
stationsIndia <- ghcnd_stations(country = "IN")
```

For now we'll filter the ones that have "DELHI" in their names, but later we'll use geographical information for doing this.

```{r, message = FALSE, warning = FALSE}
library("ggmap")
stationsDelhi <- filter(stationsIndia$data, grepl("DELHI", name))
map <- get_map(location = "Delhi", zoom = 8)
ggmap(map) + 
  geom_point(aes(x = longitude, y = latitude),
             data = stationsDelhi)
```


# Query weather data for these stations

# Join the two tables, thus complementing the original table

